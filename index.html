<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 10</title>
    <script src=" https://cdn.jsdelivr.net/npm/phaser@3.22.0/dist/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 1280,
    height: 720,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 300 },
            debug: true
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

var player;
var speed = 1;
var canJump = true;
var canMove = true;
var canDash = false;
var canUseSpell = false;
var spellAnim = true;
var spellBall;
var bossDoor = true;

var game = new Phaser.Game(config);

function preload ()
{
    //this.load.image('background', 'assets/background.jpg');
    this.load.image('superboost', 'assets/superboost.png');
    this.load.image('tiles', 'assets/tileset.png');
    this.load.tilemapTiledJSON('map', 'map.json');
    this.load.spritesheet('dude', 'assets/spritesheet_4.png', { frameWidth: 114, frameHeight: 104 });
    this.load.image('spellBall', 'assets/spell.png');
    this.load.image('spellBoost', 'assets/spellboost.png');
    this.load.image('open_door', 'assets/unlock_boss.png');
}

function create ()
{
    //this.cameras.main.setViewport(0,0,1280,720)
    //const backgroundImage = this.add.image(0,0, 'background').setOrigin(0, 0);
    /*this.cameras.main.setBounds(0, 0, 1280 * 2, 720 * 2);
    this.physics.world.setBounds(0, 0, 1280 * 2, 720 * 2);*/
    const map = this.make.tilemap({key: 'map'});
    const tileset = map.addTilesetImage('tileset', 'tiles');
    const rocks = map.createStaticLayer('rocks', tileset, 0, 0);
    const icy_rocks = map.createStaticLayer('icy_rocks', tileset, 0, 0);
    const spikes = map.createStaticLayer('spikes', tileset, 0, 0);
    const snow = map.createStaticLayer('snow', tileset, 0, 0);
    boss_door = map.createDynamicLayer('boss_door', tileset, 0, 0);
    //const ennemies = map.createStaticLayer('ennemies', tileset, 0, 0);
    spellBall = this.physics.add.group();
    
    
    //power-ups
    superboost = this.physics.add.staticGroup();
    spellBoost = this.physics.add.staticGroup();
    open_door = this.physics.add.staticGroup();
    superboost.create(800, 150, 'superboost').setScale(0.3).refreshBody();
    spellBoost.create(1225, 700, 'spellBoost').setScale(0.3).refreshBody();
    open_door.create(1370, 1295, 'open_door').setScale(0.3).refreshBody();
    
    
    // setting collisions
    rocks.setCollisionByExclusion(-1, true);
    icy_rocks.setCollisionByExclusion(-1, true);
    spikes.setCollisionByExclusion(-1, true);
    snow.setCollisionByExclusion(-1, true);
    boss_door.setCollisionByExclusion(-1, true);
    
    
    player = this.physics.add.sprite(150, 1250, 'dude');
    //player.setCollideWorldBounds(true);
    
    //icy_rocks.setFriction(0,1);
    
    
    //animations
    this.cameras.main.startFollow(player);
    this.cameras.main.setBounds(0, 0, map.widthInPixels, map.heightInPixels);
    this.anims.create({
        key: 'left',
        frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 5 }),
        frameRate: 10,
        repeat: -1
    });
    /*this.anims.create({
        key: 'turn',
        frames: [ { key: 'dude', frame: 4 } ],
        frameRate: 20
    });*/
    this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('dude', { start: 16, end: 21 }),
        frameRate: 10,
        repeat: -1
    });
    
    this.anims.create({
        key: 'jump',
        frames: this.anims.generateFrameNumbers('dude',{start: 11, end: 11}),
        frameRate: 10,
        repeat: -1
    });
    
    this.anims.create({
        key: 'dash_left',
        frames: this.anims.generateFrameNumbers('dude', {start: 9, end: 9}),
        frameRate: 10,
        repeat: -1
    });
    
    this.anims.create({
        key: 'dash_right',
        frames: this.anims.generateFrameNumbers('dude', {start: 12, end: 12}),
        frameRate: 10,
        repeat: -1
    });
    
    this.anims.create({
        key: 'spell',
        frames: this.anims.generateFrameNumbers('dude', {start: 13, end: 15})
    })
    
    this.anims.create({
        key: 'idle',
        frames: this.anims.generateFrameNumbers('dude', {start: 22, end: 24}),
        frameRate: 10,
        repeat: -1
    });
    
    //cursors = this.input.keyboard.createCursorKeys();
    keys = this.input.keyboard.addKeys('UP, DOWN, LEFT, RIGHT, SPACE, E');
    //spacebar = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
    
    
    //collisions
    this.physics.add.collider(player, snow, onSnow);
    this.physics.add.collider(player, rocks, onGround);
    this.physics.add.collider(player, icy_rocks, onIce);
    this.physics.add.collider(player, spikes/*, getSpiked*/);
    this.physics.add.overlap(player, superboost, getDash);
    this.physics.add.overlap(player, spellBoost, getSpell);
    this.physics.add.overlap(player, open_door, unlockDoor);
    this.physics.add.collider(spellBall, rocks, ballTouchingWall, null, this);
    this.physics.add.collider(player, boss_door/*, getTileId*/);
}

/*function getTileId(player, boss_door){
    console.log(boss_door.index);
}  */  

// get a spell bu overlapping with spellboost
function getSpell(player, spellBoost){
    spellBoost.disableBody(true, true);
    canUseSpell = true;
}    
    
    
// remove boss door    
function unlockDoor(player, open_door){
    open_door.disableBody(true, true);
    map.destroyLayer('boss_door');
    //destroy(boss_door);
    boss_door.removeTileAt(20,54);
    //boss_door.removeTileAt(32,13);
}    

//removes spell ball when it touches a rock        
function ballTouchingWall(spellBall, rocks){
    spellBall.disableBody(true, true);
}    
   
// spell    
function launchBall(){
    newBall = spellBall.create(player.x + 114, player.y, 'spellBall');
    newBall.setVelocityX(300);
    newBall.body.setAllowGravity(false);
}    
 
//makes player unable to control the character when on Ice    
function onIce(){
    console.log('onIce');
    if (keys.RIGHT.isDown && canMove){
        player.setVelocityX(300);
    }
    if (keys.LEFT.isDown && canMove){
        player.setVelocityX(-300);
    }
    player.setVelocityX * 1;
    canMove = false;
    canJump = false;
    if (player.body.velocity == 0){
        if (keys.RIGHT.isDown && canSlide){
            player.setVelocityX (400);
            canSlide = false;
            setTimeout(function(){canSlide = true}, 1000);
        }
        if (keys.LEFT.isDown && canSlide){
            player.setVelocityX (-400);
            canSlide = false;
            setTimeout(function(){canSlide = true}, 1000);
        }
    }
    
    if (player.body.blocked.right){
        player.setVelocityX(-300);
    }
    else if (player.body.blocked.left){
        player.setVelocityX(300);
    }
}
    
//resets controls to the character when on Ground    
function onGround(){
    console.log('onGround');
    setTimeout(function(){canMove = true}, 200);
    setTimeout(function(){canJump = true}, 500);
    //setTimeout(function(){speed = 1}, 500);
}
    
/*function getSpiked(){
    return;
}   */ 
   
// slows the player    
function onSnow(){
    console.log('onSnow');
    /*player.setVelocityX(0);
    if (keys.LEFT.isDown && !player.body.blocked.left && canMove)
    {
        player.setVelocityX(-150);

        //player.anims.play('left', true);
    }
    else if (keys.RIGHT.isDown && !player.body.blocked.right && canMove)
    {
        player.setVelocityX(150);

        player.anims.play('right', true);
    }*/
    speed = 0.5;
}    

// give the player the ability to dash when overlapping with superboost    
function getDash(player, superboost){
    superboost.disableBody(true, true);
    canDash = true;
}    
    
function update ()
{
    
    //character movement
    if (keys.LEFT.isDown && !player.body.blocked.left && canMove)
    {
        player.setVelocityX(-300 * speed);
        if (player.body.onFloor()){
            player.anims.play('left', true);
        }
    }
    else if (keys.RIGHT.isDown && !player.body.blocked.right && canMove)
    {
        player.setVelocityX(300 * speed);
        if (player.body.onFloor()){
            player.anims.play('right', true);
        }
    }
    else if (player.body.onFloor() && canMove && spellAnim)
    {
        player.setVelocityX(0);

        player.anims.play('idle', true);
    }

    if (keys.UP.isDown && player.body.onFloor() && canJump)
    {
        player.setVelocityY(-530);
        player.anims.play('jump', true);
        canJump = false;
        canMove = false;
        setTimeout(function(){canJump = true}, 500);
        setTimeout(function(){canMove = true}, 800);
        
    }
    
    if (keys.UP.isDown && player.body.blocked.right && canJump){
        player.setVelocityX(-330);
        player.setVelocityY(-500);
        player.anims.play('jump', true);
        canJump = false;
        canMove = false;
        setTimeout(function(){canJump = true}, 500);
        setTimeout(function(){canMove = true}, 800);
    }
    
    if (keys.UP.isDown && player.body.blocked.left && canJump){
        player.setVelocityX(330);
        player.setVelocityY(-500);
        player.anims.play('jump', true);
        canMove = false;
        canJump = false;
        setTimeout(function(){canJump = true}, 500);
        setTimeout(function(){canMove = true}, 800);
    }
    
    if(keys.SPACE.isDown && keys.LEFT.isDown && canDash){
        player.anims.play('dash_left', true);
        console.log('space');
        speed = 2;
        if (keys.SPACE.getDuration() > 1000) {
            speed = 1;
        }
    }
    
    if(keys.SPACE.isDown && keys.RIGHT.isDown && canDash){
        player.anims.play('dash_right', true);
        console.log('space');
        speed = 2;
        if (keys.SPACE.getDuration() > 1000) {
            speed = 1;
        }
    }
    
    if(keys.SPACE.isUp){
        speed = 1;
    }
    
    //using spell
    if(keys.E.isDown && canUseSpell){
        player.anims.play('spell', true);
        console.log('spell');
        launchBall();
        /*spellBall = spellBall.create(player.x + 114, player.y, 'spellBall');
        spellBall.setVelocityX(300);
        spellBall.body.setAllowGravity(false);*/
        canUseSpell = false;
        spellAnim = false;
        setTimeout(function(){canUseSpell = true}, 1000);
        setTimeout(function(){spellAnim = true}, 1000);
    }
    
}
</script>

</body>
</html>